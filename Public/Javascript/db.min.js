const sql=require("mssql/msnodesqlv8"),{passwordCompare,passwordHash}=require("./passwordHash");async function SqlQuery(e,t,o,n,r){const c=new sql.ConnectionPool({server:""+e,port:o,database:""+t,options:{trustedConnection:!0}}),a=(await c.connect(),new sql.Request(c));try{r(await a.query(n))}catch(e){c.close(),r(e)}c.close()}function addAuthenticationData(e,t,o,n){SqlQuery("5C\\SQLEXPRESS","kovenantz",5e3,`insert into Authentication values ('${e}', '${t}', '${o}', '${n}');`,e=>{})}function addEmpDetails(t,e,o,n,r,c,a,i,l,s){SqlQuery("5C\\SQLEXPRESS","kovenantz",5e3,`insert into EmpDetails values ('${t}', '${e}', '${o}', '${n}', '${r}', '${c}', '${a}')`,e=>{e instanceof Error?s(!1,"mail id already exists !"):1!=e.rowsAffected[0]?s(!1,"cannot register"):s(!0,"registration sucess !")}),passwordHash(i,e=>{addAuthenticationData(""+e,""+t,""+l,""+n)})}function checkAuthentication(e,t,o){SqlQuery("5C\\SQLEXPRESS","kovenantz",5e3,`select * from Authentication where email = '${e}'`,e=>{void 0===e.recordset[0]?o(!1,"no user data found"):!0===e.recordset[0].profileLock?o(!1,"profile locked ! Contact admin..."):passwordCompare(t,e.recordset[0].passWord,e=>{e?o(!0,"sucess"):o(!1,"login credentials are incorrect !")})})}function AuthlockProfile(e,t){SqlQuery("5C\\SQLEXPRESS","kovenantz",5e3,`UPDATE Authentication
  SET profileLock = 1
  WHERE email = '${e}';`,e=>{e instanceof Error?t(!1):t(!0)})}function checkEmpEmail(e,t){SqlQuery("5C\\SQLEXPRESS","kovenantz",5e3,`SELECT emailAddress FROM EmpDetails WHERE emailAddress = '${e}';`,e=>{t(0<e.recordset.length)})}function fetchEmployeeDetails(e,t){SqlQuery("5C\\SQLEXPRESS","kovenantz",5e3,`SELECT * FROM EmpDetails WHERE emailAddress = '${e}';`,e=>{t(e.recordset[0])})}function checkIn(e,t){var o=(new Date).toISOString().slice(0,10),n=(new Date).toISOString();SqlQuery("5C\\SQLEXPRESS","kovenantz",5e3,`insert into Attendance values ('${e}', '${o}', '${n}', '${n}', '${t}', '1') `,e=>{})}function checkOut(e){SqlQuery("5C\\SQLEXPRESS","kovenantz",5e3,`update Attendance set checkOut = '${(new Date).toISOString()}', checked = '0' where email = '${e}' AND checked='1' AND workingDay = '${(new Date).toISOString().slice(0,10)}'`,e=>{})}function fetchBtnStatus(e,t){SqlQuery("5C\\SQLEXPRESS","kovenantz",5e3,`select checked from Attendance where email = '${e}' AND checked = '1' AND workingDay = '${(new Date).toISOString().slice(0,10)}'`,e=>{t(e.recordset)})}function fetchAttendance(e,t){SqlQuery("5C\\SQLEXPRESS","kovenantz",5e3,`select * from Attendance where email = '${e}' ORDER BY checkIn ASC`,e=>{e instanceof Error&&t([]),t(e.recordset)})}function fetchAttendanceToday(e,t){SqlQuery("5C\\SQLEXPRESS","kovenantz",5e3,`select * from Attendance where email = '${e}' AND workingDay = '${(new Date).toISOString().slice(0,10)}' ORDER BY checkIn ASC`,e=>{e instanceof Error&&t([]),t(e.recordset)})}function fetchDuration(e,t){SqlQuery("5C\\SQLEXPRESS","kovenantz",5e3,`select distinct workingDay, sum(DATEDIFF(MILLISECOND, checkIn, checkOut)) as duration from Attendance where email = '${e}' group by workingDay order by workingDay ASC`,e=>{!e instanceof Error?t([]):t(e.recordset)})}function addAuthCode(e,t,o){SqlQuery("5C\\SQLEXPRESS","kovenantz",5e3,`insert into AuthCode values('${e}', '${t}')`,e=>{e instanceof Error?o(!1):o(!0)})}function fetchAuthCode(e,t){SqlQuery("5C\\SQLEXPRESS","kovenantz",5e3,`select authCode from AuthCode where email = '${e}'`,e=>{e instanceof Error?t(null):t(e.recordset[0].authCode)})}function removeFromAuthCode(e,t){SqlQuery("5C\\SQLEXPRESS","kovenantz",5e3,`delete from AuthCode where email = '${e}'`,e=>{e instanceof Error?t(!1):t(!0)})}function insertTolockProfile(e,t,o){SqlQuery("5C\\SQLEXPRESS","kovenantz",5e3,`insert into lockProfile values ('${e}', ${t})`,e=>{e instanceof Error?o(!1):o(!0)})}function updateLockProfile(e,t,o){SqlQuery("5C\\SQLEXPRESS","kovenantz",5e3,`update lockProfile set lockCount = ${t} where email = '${e}'`,e=>{e instanceof Error?o(!1):o(!0)})}function fetchCountlockProfile(e,t){SqlQuery("5C\\SQLEXPRESS","kovenantz",5e3,`select lockCount from lockProfile where email = '${e}'`,e=>{e instanceof Error?t(null):t(e.recordset[0].lockCount)})}function deleteFromlockProfile(e,t){SqlQuery("5C\\SQLEXPRESS","kovenantz",5e3,`delete from lockProfile where email = '${e}'`,e=>{e instanceof Error?t(!1):t(!0)})}module.exports={checkAuthentication:checkAuthentication,fetchAttendance:fetchAttendance,fetchAttendanceToday:fetchAttendanceToday,checkIn:checkIn,checkOut:checkOut,fetchEmployeeDetails:fetchEmployeeDetails,AuthlockProfile:AuthlockProfile,checkEmpEmail:checkEmpEmail,addEmpDetails:addEmpDetails,fetchDuration:fetchDuration,fetchBtnStatus:fetchBtnStatus,addAuthCode:addAuthCode,removeFromAuthCode:removeFromAuthCode,fetchAuthCode:fetchAuthCode,insertTolockProfile:insertTolockProfile,updateLockProfile:updateLockProfile,fetchCountlockProfile:fetchCountlockProfile,deleteFromlockProfile:deleteFromlockProfile};